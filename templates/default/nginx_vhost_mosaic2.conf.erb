server {

    server_name <%= @hostname %>;
    listen <%= @listen_port %>;

    access_log <%= @log_dir %>/<%= @appname %>-access.log combined;
    error_log  <%= @log_dir %>/<%= @appname %>-error.log;
    rewrite_log on;

    client_max_body_size 4G;
    charset utf-8;

    index  index.php index.html;

<% if @ssl_key && @ssl_cert -%>
    ssl on;
    ssl_certificate     <%= @ssl_cert %>;
    ssl_certificate_key <%= @ssl_key %>;
    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!EDH:!AESGCM;
    ssl_prefer_server_ciphers on;
<% end -%>

    location / {

        root <%= @root_path %>/client/web;

        try_files $uri $uri/ /index.php?$uri&$args;

        rewrite ^/details /scripts/get_details.php last;
        rewrite ^/modules/(.*) /scripts/get_file.php?type=modules&path=modules/$1 last;
        rewrite ^/skins/(.*) /scripts/get_file.php?type=skins&path=skins/$1 last;
        rewrite ^/update /scripts/push_update.php last;

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(.*)$;
            fastcgi_pass   backend;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  <%= @root_path %>/client/web$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_param  QUERY_STRING     $query_string;
            fastcgi_param  REQUEST_METHOD   $request_method;
            fastcgi_param  CONTENT_TYPE     $content_type;
            fastcgi_param  CONTENT_LENGTH   $content_length;
            fastcgi_intercept_errors        on;
            fastcgi_ignore_client_abort     off;
            fastcgi_connect_timeout 60;
            fastcgi_send_timeout 180;
            fastcgi_read_timeout 180;
            fastcgi_buffer_size 128k;
            fastcgi_buffers 4 256k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
        }

    }

    location /server {

        alias <%= @root_path %>/server/web;

        try_files $uri $uri/ /index.php?$uri&$args;

        rewrite ^/server/debug /server/scripts/debug.php last;
        rewrite ^/server/details /server/scripts/get_details.php last;
        rewrite ^/server/project/display/([^/]+)/([^/]+)/(.*) /server/scripts/get_project_file.php?clientToken=$1&projectId=$2&path=$3 last;
        rewrite ^/server/project/download/([^/]+)/([^/]+)/(.*) /server/scripts/download_project_file.php?clientToken=$1&projectId=$2&path=$3 last;
        rewrite ^/server/update /server/scripts/push_update.php last;
        rewrite ^/server/upload/([^/]+)/(.*) /server/scripts/upload_file.php?clientToken=$1 last;
        rewrite ^/server/user/([^/]+)/(.*) /server/scripts/get_user_avatar.php?clientToken=$1&userId=$2 last;

        location ~ \.php$ {
            fastcgi_split_path_info ^/server(.+\.php)(.*)$;
            fastcgi_pass   backend;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  <%= @root_path %>/server/web$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_param  QUERY_STRING     $query_string;
            fastcgi_param  REQUEST_METHOD   $request_method;
            fastcgi_param  CONTENT_TYPE     $content_type;
            fastcgi_param  CONTENT_LENGTH   $content_length;
            fastcgi_intercept_errors        on;
            fastcgi_ignore_client_abort     off;
            fastcgi_connect_timeout 60;
            fastcgi_send_timeout 180;
            fastcgi_read_timeout 180;
            fastcgi_buffer_size 128k;
            fastcgi_buffers 4 256k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
        }

    }

}


upstream backend {
    server 127.0.0.1:9001;
}